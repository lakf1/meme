<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Fusion</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .preview {
            width: 300px;
            height: 300px;
            border: 2px dashed #ccc;
            margin: 10px 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .image-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 20px;
        }
        
        .result-image {
            max-width: 512px;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 8px;
        }

        .progress-container {
            width: 300px;
            margin: 20px 0;
            display: none;  /* Hidden by default */
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Fusion</h1>
        
        <div class="upload-section">
            <div>
                <h3>Image 1</h3>
                <input type="file" id="image1" accept="image/*">
                <div id="preview1" class="preview"></div>
            </div>
            
            <div>
                <h3>Image 2</h3>
                <input type="file" id="image2" accept="image/*">
                <div id="preview2" class="preview"></div>
            </div>
        </div>

        <div class="image-container">
            <button onclick="uploadImages()">Generate Image</button>
            
            <div id="progressContainer" class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">0%</div>
            </div>
            
            <div id="result"></div>
        </div>
    </div>

    <script>
        // Generate a UUID v4
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Generate browser fingerprint
        function generateBrowserId() {
            const browserInfo = [
                navigator.userAgent,
                navigator.language,
                screen.width,
                screen.height,
                new Date().getTimezoneOffset()
            ].join('|');
            
            // Create a hash of the browser info
            return Array.from(
                new Uint8Array(
                    new TextEncoder().encode(browserInfo)
                )
            ).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Generate the IDs once and store them in localStorage
        const DEVICE_ID = localStorage.getItem('deviceId') || generateUUID();
        const BROWSER_ID = localStorage.getItem('browserId') || generateBrowserId();
        const PAGE_ID = generateUUID(); // New for each page load

        // Store the persistent IDs
        localStorage.setItem('deviceId', DEVICE_ID);
        localStorage.setItem('browserId', BROWSER_ID);

        const API_TOKENS = [
            "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWEtYXJ0IiwiYXVkIjpbImxvZ2luIl0sImV4cCI6MTczOTc0NzYyMCwiaWF0IjoxNzM0NTYzNjIwLCJqdGkiOiI1ODk0Mzk0Mjk0MzU4NTI4NSIsInBheWxvYWQiOnsiaWQiOiI0YzBlOTE5ZmNjMzY4ZGRjMDNmMzQ5MmM2MGRhMmQ0ZCIsImVtYWlsIjoiOXNxcnQ5QGdtYWlsLmNvbSIsImNyZWF0ZV9hdCI6MTczNDU2MTY0MDg5NiwidG9rZW5fc3RhdHVzIjowLCJzdGF0dXMiOjEsImlzcyI6IiJ9fQ.qHn5ig9PuWlFYyY-pcmQYz4ciVv-Pl0mJDzTM0uqCyWDZd04qkm7iw39GdmF-q5AjRzaoqs0UL6U7dbgGpF8PLzXokQvX44jIJ5Mg38w8FxC15TeDvfKYj3V1O_l6kNKtG7snXu799Bja3EkUyI8ea_sJIQc5oGeJPkUuEvKfIP8lreA6Ljm31xDhNL-Nor2qQvjfPKwzPAfkBbYwrILLSF7-RMlp49xdwA63Eazp1yvBuwFiYjPvUviufH44lbhEA3oHVmJd_ah7IssFueknYP221KgS8_aV3Cq7TaLTxDwIYNyUkZMLdDtMl7PMwvCqTjVDsqYhli_uYV1wDI8dA",
            "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzZWEtYXJ0IiwiYXVkIjpbImxvZ2luIl0sImV4cCI6MTczOTc0NTcwOSwiaWF0IjoxNzM0NTYxNzA5LCJqdGkiOiI1ODk0MTkzOTYxNTAxMTg0NSIsInBheWxvYWQiOnsiaWQiOiIwYzdiYWRmYzZiMmFhMGNiNDVjYzZlNGRmMjI0YzJkOSIsImVtYWlsIjoiZXZvY2hrYTU1OUBnbWFpbC5jb20iLCJjcmVhdGVfYXQiOjE3MzQ1NjE3MDc5NzgsInRva2VuX3N0YXR1cyI6MCwic3RhdHVzIjoxLCJpc3MiOiIifX0.AI9vVAPQ0-5VPSbQJqsVifKQvTYDrpYOd5NDcvK52ofMVeu8sP3_dAsXuPIQ8R67CcnLXhb_FykRh9BbpVQ5bjsEFdCf4AEXEOczQamn8cjNOHhrarOALabZdzj-5siZLLtb08hv6lSLXVDs0qpZjZ_nqaofcLm2_Vc59BsrVIpEdu_kJdJ-La558TsakB_JSnCxRlfxrD_eTIENGgQO9GdR1J7ibcIAZDtEsicBrPzRL-P_AleWujB8tGwB-tkSmEPKf50R8lUkqWOzDygYNeUf1u0LY576RsAre6ZaQy_xn_4SQmULiAid2FfdSF1Mewwc0vNdW2SNDMJkXP0tYQ"
        ];

        // Check if a token is currently being used
        async function isTokenInUse(token) {
            try {
                const response = await fetch("https://www.seaart.ai/api/v1/task/batch-progress", {
                    method: "POST",
                    headers: {
                        "accept": "application/json, text/plain, */*",
                        "content-type": "application/json",
                        "token": token,
                        "x-app-id": "web_global_seaart"
                    },
                    body: JSON.stringify({
                        "task_ids": ["dummy"]
                    }),
                    mode: "cors"
                });

                const data = await response.json();
                
                // If we get an auth error, token is not in use
                // If we get a different error, token might be in use
                return data.status?.code !== 20002; // 20002 is auth error
            } catch (error) {
                console.error('Error checking token:', error);
                return true; // Assume token is in use if check fails
            }
        }

        async function getNextToken() {
            for (const token of API_TOKENS) {
                const inUse = await isTokenInUse(token);
                if (!inUse) {
                    return token;
                }
            }
            throw new Error('All tokens are currently in use');
        }

        // Use localStorage to remember which token index this user last used
        let currentTokenIndex = parseInt(localStorage.getItem('lastTokenIndex') || '0');

        function getNextToken() {
            // Get next token index, cycling through available tokens
            currentTokenIndex = (currentTokenIndex + 1) % API_TOKENS.length;
            
            // Store the index for this user
            localStorage.setItem('lastTokenIndex', currentTokenIndex.toString());
            
            // Return the token
            return API_TOKENS[currentTokenIndex];
        }

        // Function to calculate SHA-256 hash of file
        async function calculateHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Function to preview image
        function previewImage(file, previewId) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(previewId).style.backgroundImage = `url(${e.target.result})`;
            }
            reader.readAsDataURL(file);
        }

        async function uploadImage(file) {
            const token = getNextToken();
            try {
                console.log('Starting upload for file:', file.name);
                
                // Step 1: Calculate hash
                const hashVal = await calculateHash(file);
                console.log('Calculated hash:', hashVal);
                
                // Step 1: Get pre-signed URL
                console.log('Requesting pre-signed URL...');
                const preSignResponse = await fetch("https://www.seaart.ai/api/v1/resource/uploadImageByPreSign", {
                    method: "POST",
                    headers: {
                        "accept": "application/json, text/plain, */*",
                        "accept-language": "en",
                        "cache-control": "no-cache",
                        "content-type": "application/json",
                        "pragma": "no-cache",
                        "token": token,
                        "x-app-id": "web_global_seaart",
                        "x-browser-id": "d6829cc2da461ada7567e2ce1a2da45c",
                        "x-device-id": "ac01d1e4-5940-48d8-bb0e-d6a76f06f597",
                        "x-eyes": "true",
                        "x-platform": "web"
                    },
                    body: JSON.stringify({
                        content_type: file.type,
                        file_name: file.name,
                        file_size: file.size,
                        category: 20,
                        hash_val: hashVal
                    })
                });

                const preSignData = await preSignResponse.json();
                console.log('Pre-signed URL response:', preSignData);
                
                if (preSignData.status.code !== 10000) {
                    throw new Error(`Failed to get pre-signed URL: ${preSignData.status.msg}`);
                }
                
                // Step 2: Upload to storage
                console.log('Uploading to storage...');
                const uploadResponse = await fetch(preSignData.data.pre_sign, {
                    method: "PUT",
                    headers: {
                        "content-type": file.type,
                    },
                    body: file
                });
                console.log('Upload response:', uploadResponse);

                if (!uploadResponse.ok) {
                    throw new Error(`Upload failed with status: ${uploadResponse.status}`);
                }

                // Step 3: Confirm upload
                console.log('Confirming upload...');
                const confirmResponse = await fetch("https://www.seaart.ai/api/v1/resource/confirmImageUploadedByPreSign", {
                    method: "POST",
                    headers: {
                        "content-type": "application/json",
                        "token": token,
                        "x-app-id": "web_global_seaart",
                        "x-platform": "web",
                        "x-eyes": "true"
                    },
                    body: JSON.stringify({
                        category: 20,
                        file_id: preSignData.data.file_id
                    })
                });

                const confirmData = await confirmResponse.json();
                console.log('Confirm response:', confirmData);
                
                if (confirmData.status.code !== 10000) {
                    throw new Error(`Confirmation failed: ${confirmData.status.msg}`);
                }

                return confirmData;
            } catch (error) {
                console.error('Upload failed:', error);
                throw error;
            }
        }

        let uploadedImages = {
            image1: null,
            image2: null
        };

        // Handle file input changes
        document.getElementById('image1').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(file) {
                console.log('Image 1 selected:', file);
                previewImage(file, 'preview1');
                try {
                    const uploadResult = await uploadImage(file);
                    console.log('Image 1 upload completed:', uploadResult);
                    uploadedImages.image1 = uploadResult.data.url; // Store the URL instead of file_id
                    console.log('Stored image1 URL:', uploadedImages.image1);
                } catch (error) {
                    console.error('Image 1 upload failed:', error);
                    alert('Upload failed: ' + error.message);
                }
            }
        });

        document.getElementById('image2').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(file) {
                previewImage(file, 'preview2');
                try {
                    const uploadResult = await uploadImage(file);
                    console.log('Image 2 upload completed:', uploadResult);
                    uploadedImages.image2 = uploadResult.data.url; // Store the URL instead of file_id
                } catch (error) {
                    console.error('Image 2 upload failed:', error);
                    alert('Upload failed: ' + error.message);
                }
            }
        });

        // Add this function to get a fresh token
        async function getFreshToken() {
            try {
                const response = await fetch("https://www.seaart.ai/api/v1/user/token/refresh", {
                    method: "POST",
                    headers: {
                        "accept": "application/json, text/plain, */*",
                        "content-type": "application/json",
                        "x-app-id": "web_global_seaart",
                        "x-platform": "web",
                        "x-eyes": "true"
                    }
                });
                
                const data = await response.json();
                if (data.status?.code === 10000) {
                    return data.data.token;
                }
                throw new Error('Failed to refresh token');
            } catch (error) {
                console.error('Token refresh failed:', error);
                throw error;
            }
        }

        // Function to generate a random ID similar to "cplv98le878c73br9rr0"
        function generateApplyId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            const timestamp = Date.now().toString(36);
            const random = Array(8).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
            return `cpl${timestamp}${random}`;
        }

        async function updateProgress(percent) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            container.style.display = 'block';
            fill.style.width = `${percent}%`;
            text.textContent = `${percent}%`;
        }

        async function pollProgress(taskId, token) {
            console.log('Polling started for task:', taskId);
            
            let attempts = 0;
            const maxAttempts = 60;
            
            const STATUS_CODES = {
                1: 'pending',
                2: 'processing',
                3: 'completed',
                4: 'failed',
                5: 'cancelled'
            };
            
            while (attempts < maxAttempts) {
                try {
                    attempts++;
                    console.log(`Polling attempt ${attempts} for task: ${taskId}`);

                        const response = await fetch("https://www.seaart.ai/api/v1/task/batch-progress", {
                            method: "POST",
                            headers: {
                                "accept": "application/json, text/plain, */*",
                                "content-type": "application/json",
                                "token": token,
                                "x-app-id": "web_global_seaart"
                            },
                            body: JSON.stringify({
                                "task_ids": [taskId]
                            }),
                            mode: "cors"
                        });

                        const data = await response.json();
                        
                        if (data.status?.code === 10000 && data.data?.items?.length > 0) {
                            const taskResult = data.data.items[0];
                            console.log('Task status:', STATUS_CODES[taskResult.status] || 'unknown', '(code:', taskResult.status, ')');
                            
                            switch (taskResult.status) {
                                case 3: // Completed
                                    if (taskResult.img_uris && taskResult.img_uris.length > 0) {
                                        const imageUrl = taskResult.img_uris[0].url;
                                        console.log('Success! Image URL:', imageUrl);
                                        
                                        // Hide progress bar on completion
                                        document.getElementById('progressContainer').style.display = 'none';
                                        
                                        // Create and display the image
                                        const resultDiv = document.getElementById('result');
                                        const img = document.createElement('img');
                                        img.src = imageUrl;
                                        img.className = 'result-image';
                                        
                                        // Clear previous results
                                        resultDiv.innerHTML = '';
                                        resultDiv.appendChild(img);
                                        
                                        return;
                                    } else {
                                        console.error('Task completed but missing image URL. Full response:', JSON.stringify(taskResult, null, 2));
                                        throw new Error('Task completed but no image URL found in response');
                                    }
                                
                                case 2: // Processing
                                    console.log('Processing:', taskResult.process + '%');
                                    await updateProgress(taskResult.process);
                                    break;
                                
                                case 4: // Failed
                                case 5: // Cancelled
                                    document.getElementById('progressContainer').style.display = 'none';
                                    throw new Error(`Task ${STATUS_CODES[taskResult.status]}: ${taskResult.status_desc}`);
                                
                                case 1: // Pending
                                    console.log('Task pending...');
                                    await updateProgress(0);
                                    break;
                                
                                default:
                                    console.log('Unknown status code:', taskResult.status);
                            }
                        }

                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (error) {
                        console.error('Polling error:', error);
                        if (attempts >= maxAttempts) {
                            throw new Error(`Polling timed out after ${maxAttempts} attempts`);
                        }
                        if (error.message.includes('Task failed') || error.message.includes('Task cancelled')) {
                            throw error;
                        }
                    }
                }

            throw new Error(`Polling timed out after ${maxAttempts} attempts`);
        }

        async function uploadImages() {
            try {
                if (!uploadedImages.image1 || !uploadedImages.image2) {
                    throw new Error('Please upload both images first');
                }

                await updateProgress(0);
                
                const token = await getNextToken();  // Wait for available token
                const applyId = generateApplyId();
                
                const response = await fetch("https://www.seaart.ai/api/v1/creativity/generate/apply", {
                        "headers": {
                            "accept": "application/json, text/plain, */*",
                            "content-type": "application/json",
                            "token": token,
                            "x-app-id": "web_global_seaart"
                        },
                        "body": `{"apply_id":"cplv98le878c73br9rr0","inputs":[{"field":"image","node_id":"11","node_type":"LoadImage","val":"${uploadedImages.image1}"},{"field":"weight","node_id":"193","node_type":"IPAdapterAdvanced","val":0.5},{"field":"image","node_id":"25","node_type":"LoadImage","val":"${uploadedImages.image2}"},{"field":"weight","node_id":"192","node_type":"IPAdapterAdvanced","val":0.7000000000000001}]}`,
                        "method": "POST",
                        "mode": "cors"
                    });

                const data = await response.json();
                console.log('Generate response:', data);

                if (data.status?.code !== 10000) {
                    throw new Error(`API Error: ${data.status?.msg} (code: ${data.status?.code}). Details: ${JSON.stringify(data)}`);
                }

                if (!data.data?.id) {
                    throw new Error('No task ID in response');
                }

                console.log('Starting to poll for task:', data.data.id);
                await pollProgress(data.data.id, token);  // Pass the same token

            } catch (error) {
                document.getElementById('progressContainer').style.display = 'none';
                console.error('Error:', error);
                alert('Fusion failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
